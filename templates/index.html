<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACE Report Hub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ ACE Report Hub</h1>
            <p class="subtitle">Weekly AWS Partner Central ACE Hygiene Reports</p>
        </header>

        <div class="info-banner">
            <strong>Excluded Legacy Ops:</strong> {{ excluded_ops_count }} opportunities are tracked but excluded from reports
        </div>

        {% if has_baseline %}
        <!-- IMPORTED SNAPSHOTS SUMMARY -->
        <div class="section" style="background: #f0f8ff; border-left: 4px solid #4a90e2;">
            <h2>üìÇ Imported ACE Export Files</h2>
            <p class="subtitle">All snapshots stored in the database</p>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr style="background: #4a90e2; color: white;">
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Snapshot #</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Report Week</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Import Date</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Filename</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Total Ops</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Stale Ops</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for snapshot in all_snapshots %}
                        <tr style="{% if loop.index % 2 == 0 %}background: #f9f9f9;{% endif %}">
                            <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold; color: #4a90e2;">
                                #{{ snapshot.snapshot_id }}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                {% if snapshot.report_week_date %}
                                    {{ snapshot.report_week_date }}
                                {% else %}
                                    <em style="color: #999;">Not specified</em>
                                {% endif %}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                {{ snapshot.snapshot_date[:10] }}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace; font-size: 13px;">
                                {{ snapshot.ace_export_filename }}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">
                                {{ snapshot.total_reportable_ops }}
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; {% if snapshot.stale_ops_count > 0 %}color: #d9534f; font-weight: bold;{% endif %}">
                                {{ snapshot.stale_ops_count }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p style="margin-top: 15px; color: #666; font-size: 14px;">
                Total Snapshots: <strong>{{ all_snapshots|length }}</strong> |
                <a href="/history" style="color: #4a90e2; text-decoration: none; font-weight: bold;">View Detailed History ‚Üí</a>
            </p>
        </div>
        {% endif %}

        <!-- SIMPLE EMAIL TEST BUTTON -->
        <div class="section" style="background: #f0f8ff; border: 2px solid #4a90e2;">
            <h2>üß™ Email System Test</h2>
            <p>Send a basic test email to verify SMTP works</p>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="testEmailPassword" placeholder="Enter Gmail App Password" style="flex: 1; padding: 10px; font-family: monospace; border: 1px solid #ccc; border-radius: 4px;">
                <button onclick="sendBasicTestEmail()" class="btn btn-warning">
                    üìß Send Basic Test Email
                </button>
            </div>
            <div id="testEmailStatus" class="status-message"></div>
        </div>

        {% if not has_baseline %}
        <!-- FIRST TIME SETUP -->
        <div class="section setup-section">
            <h2>üì• First Time Setup</h2>
            <p>Welcome! To get started, import your first baseline ACE report.</p>
            <p>This will form the foundation for tracking weekly changes.</p>

            <div class="upload-area">
                <input type="file" id="baselineFile" accept=".xlsx" style="display: none;">
                <button onclick="document.getElementById('baselineFile').click()" class="btn btn-primary">
                    Choose Baseline File
                </button>
                <p id="baselineFileName" class="file-name"></p>

                <div style="margin-top: 20px;">
                    <label for="baselineReportDate" style="display: block; margin-bottom: 5px; font-weight: bold;">
                        Report Week Date (REQUIRED):
                    </label>
                    <input type="date" id="baselineReportDate"
                           style="padding: 10px; border: 2px solid #4a90e2; border-radius: 4px; font-size: 16px;"
                           required>
                    <p style="margin-top: 5px; color: #666; font-size: 14px;">
                        Enter the Monday of the week this report represents (e.g., 2025-10-21)
                    </p>
                </div>
            </div>

            <button id="uploadBaselineBtn" class="btn btn-success" style="display: none;">
                Import Baseline
            </button>

            <div id="baselineStatus" class="status-message"></div>
        </div>

        {% else %}
        <!-- NORMAL WORKFLOW -->
        <div class="section">
            <h2>üìä Last Report</h2>
            <div class="stats-card">
                <div class="stat">
                    <div class="stat-label">Sent Date</div>
                    <div class="stat-value">{{ last_snapshot.snapshot_date[:10] }}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Total Open Ops</div>
                    <div class="stat-value">{{ last_snapshot.total_reportable_ops }}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Avg Days</div>
                    <div class="stat-value">{{ "%.1f"|format(last_snapshot.avg_days_since_update) }}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Stale Ops</div>
                    <div class="stat-value">{{ last_snapshot.stale_ops_count }}</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìß Email Distribution List</h2>
            <button onclick="openDistributionModal()" class="btn btn-secondary">
                Manage Recipients
            </button>
            <p class="subtitle" style="margin-top: 10px;">Current recipients: <span id="recipientCount">Loading...</span></p>
        </div>

        <div class="section">
            <h2>üì§ Generate Weekly Report</h2>
            <p>Upload this week's ACE export to generate your weekly hygiene report.</p>

            <div class="upload-area">
                <input type="file" id="weeklyFile" accept=".xlsx" style="display: none;">
                <button onclick="document.getElementById('weeklyFile').click()" class="btn btn-primary">
                    Choose ACE Export File
                </button>
                <p id="weeklyFileName" class="file-name"></p>

                <div style="margin-top: 20px;">
                    <label for="weeklyReportDate" style="display: block; margin-bottom: 5px; font-weight: bold;">
                        Report Week Date (REQUIRED):
                    </label>
                    <input type="date" id="weeklyReportDate"
                           style="padding: 10px; border: 2px solid #4a90e2; border-radius: 4px; font-size: 16px;"
                           required>
                    <p style="margin-top: 5px; color: #666; font-size: 14px;">
                        Enter the Monday of the week this report represents (e.g., 2025-10-28)
                    </p>
                </div>
            </div>

            <button id="uploadWeeklyBtn" class="btn btn-success" style="display: none;">
                Generate Report
            </button>

            <div id="weeklyStatus" class="status-message"></div>

            <div id="reportSummary" style="display: none;" class="report-summary">
                <h3>Report Summary</h3>
                <div id="summaryContent"></div>

                <div class="action-buttons" style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button onclick="previewEmail()" class="btn btn-secondary">
                        üëÅÔ∏è Preview Email
                    </button>
                    <!-- REMOVED: Save Report (Do NOT Send) button - user workflow is to always send email -->
                    <!-- <button onclick="saveReport()" class="btn btn-success" id="saveReportBtn">
                        üíæ Save Report (Do NOT Send)
                    </button> -->
                    <button onclick="sendEmail()" class="btn btn-warning" id="sendEmailBtn" style="display: none;">
                        üìß Send Email to Recipients
                    </button>
                </div>
                <div id="saveStatus" class="status-message" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div class="section">
            <h2>üìú History</h2>
            <p>View past reports: <a href="/history">View All Snapshots ({{ all_snapshots|length }})</a></p>
        </div>
        {% endif %}
    </div>

    <!-- Distribution List Modal -->
    <div id="distributionModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìß Manage Email Distribution List</h2>
                <button onclick="closeDistributionModal()" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="distribution-section">
                    <h3>TO Recipients</h3>
                    <textarea id="toRecipients" rows="6" placeholder="Enter email addresses, one per line"></textarea>
                </div>
                <div class="distribution-section">
                    <h3>CC Recipients</h3>
                    <textarea id="ccRecipients" rows="6" placeholder="Enter email addresses, one per line"></textarea>
                </div>
                <div id="distributionStatus" class="status-message"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeDistributionModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveDistributionList()" class="btn btn-success">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // BASIC EMAIL TEST
        async function sendBasicTestEmail() {
            console.log('[BUTTON CLICK] üìß Send Basic Test Email');
            const password = document.getElementById('testEmailPassword').value;
            if (!password) {
                console.log('[BUTTON CLICK] ‚ùå No password entered - showing alert');
                alert('Please enter your Gmail App Password');
                return;
            }
            console.log('[BUTTON CLICK] ‚úÖ Password provided, sending test email');

            const statusEl = document.getElementById('testEmailStatus');
            statusEl.textContent = 'Sending basic test email...';
            statusEl.className = 'status-message info';

            try {
                const response = await fetch('/send_basic_test_email', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.textContent = '‚úÖ ' + data.message;
                    statusEl.className = 'status-message success';
                } else {
                    statusEl.textContent = '‚ùå Error: ' + data.error;
                    statusEl.className = 'status-message error';
                }
            } catch (error) {
                statusEl.textContent = '‚ùå Error: ' + error.message;
                statusEl.className = 'status-message error';
            }
        }

        // Baseline file upload
        document.getElementById('baselineFile')?.addEventListener('change', function(e) {
            console.log('[FILE SELECT] üìÅ Baseline file selected');
            const fileName = e.target.files[0]?.name;
            if (fileName) {
                console.log('[FILE SELECT] ‚úÖ File name:', fileName);
                document.getElementById('baselineFileName').textContent = fileName;
                document.getElementById('uploadBaselineBtn').style.display = 'block';
                console.log('[FILE SELECT] Upload Baseline button now visible');
            }
        });

        document.getElementById('uploadBaselineBtn')?.addEventListener('click', async function() {
            console.log('[BUTTON CLICK] üì§ Import Baseline');
            const fileInput = document.getElementById('baselineFile');
            const file = fileInput.files[0];
            if (!file) {
                console.log('[BUTTON CLICK] ‚ùå No file selected');
                return;
            }

            const reportDate = document.getElementById('baselineReportDate').value;
            if (!reportDate) {
                console.log('[BUTTON CLICK] ‚ùå No report date entered - showing alert');
                alert('Please enter the Report Week Date');
                return;
            }
            console.log('[BUTTON CLICK] ‚úÖ Uploading baseline with report date:', reportDate);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('report_week_date', reportDate);

            const statusEl = document.getElementById('baselineStatus');
            statusEl.textContent = 'Importing baseline...';
            statusEl.className = 'status-message info';

            try {
                const response = await fetch('/upload_baseline', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.textContent = data.message;
                    statusEl.className = 'status-message success';

                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    statusEl.textContent = 'Error: ' + data.error;
                    statusEl.className = 'status-message error';
                }
            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message;
                statusEl.className = 'status-message error';
            }
        });

        // Weekly file upload
        document.getElementById('weeklyFile')?.addEventListener('change', function(e) {
            console.log('[FILE SELECT] üìÅ Weekly ACE Export file selected');
            const fileName = e.target.files[0]?.name;
            if (fileName) {
                console.log('[FILE SELECT] ‚úÖ File name:', fileName);
                document.getElementById('weeklyFileName').textContent = fileName;
                document.getElementById('uploadWeeklyBtn').style.display = 'block';
                console.log('[FILE SELECT] Generate Report button now visible');
            }
        });

        document.getElementById('uploadWeeklyBtn')?.addEventListener('click', async function() {
            console.log('[BUTTON CLICK] üìä Generate Report');
            const fileInput = document.getElementById('weeklyFile');
            const file = fileInput.files[0];
            if (!file) {
                console.log('[BUTTON CLICK] ‚ùå No file selected');
                return;
            }

            const reportDate = document.getElementById('weeklyReportDate').value;
            if (!reportDate) {
                console.log('[BUTTON CLICK] ‚ùå No report date entered - showing alert');
                alert('Please enter the Report Week Date');
                return;
            }
            console.log('[BUTTON CLICK] ‚úÖ Generating report with date:', reportDate);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('report_week_date', reportDate);

            const statusEl = document.getElementById('weeklyStatus');
            statusEl.textContent = 'Processing report...';
            statusEl.className = 'status-message info';

            try {
                const response = await fetch('/upload_weekly', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.textContent = data.message;
                    statusEl.className = 'status-message success';

                    // Show summary
                    const summaryDiv = document.getElementById('summaryContent');
                    let html = '<div class="stats-card">';
                    html += `<div class="stat"><div class="stat-label">Open Ops</div><div class="stat-value">${data.stats.total_reportable_ops}</div></div>`;
                    html += `<div class="stat"><div class="stat-label">Avg Days</div><div class="stat-value">${data.stats.avg_days_since_update.toFixed(1)}</div></div>`;
                    html += `<div class="stat"><div class="stat-label">Stale Ops</div><div class="stat-value">${data.stats.stale_ops_count}</div></div>`;
                    html += '</div>';

                    if (data.comparison) {
                        html += '<h4>Changes Since Last Week</h4>';
                        html += `<p>New: ${data.comparison.new_ops_count} | Closed: ${data.comparison.closed_ops_count} | Status Changes: ${data.comparison.status_changes_count}</p>`;
                    }

                    summaryDiv.innerHTML = html;
                    document.getElementById('reportSummary').style.display = 'block';
                } else {
                    statusEl.textContent = 'Error: ' + data.error;
                    statusEl.className = 'status-message error';
                }
            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message;
                statusEl.className = 'status-message error';
            }
        });

        function previewEmail() {
            console.log('[BUTTON CLICK] üëÅÔ∏è Preview Email');
            window.open('/preview_email', '_blank');
        }

        async function saveReport(forceReplace = false, oldSnapshotId = null) {
            console.log('[BUTTON CLICK] üíæ Save Report', { forceReplace, oldSnapshotId });
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = 'Saving report to database...';
            statusEl.className = 'status-message info';

            try {
                let url = '/save_report';
                let body = {};

                // If user confirmed replacement, use the replace endpoint
                if (forceReplace && oldSnapshotId) {
                    url = '/save_report_replace';
                    body = { old_snapshot_id: oldSnapshotId };
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                // Handle duplicate detection (409 Conflict status)
                if (response.status === 409 && data.duplicate) {
                    const existingSnapshot = data.existing_snapshot;
                    console.log('[SAVE_REPORT] üö® DUPLICATE DETECTED!');
                    console.log('[SAVE_REPORT] Existing snapshot:', existingSnapshot);

                    const warningMsg = `‚ö†Ô∏è DUPLICATE DETECTED!\n\nA report for this week already exists:\n` +
                        `- Snapshot #${existingSnapshot.snapshot_id}\n` +
                        `- Saved: ${existingSnapshot.snapshot_date.substring(0,10)}\n` +
                        `- Total Open Ops: ${existingSnapshot.total_reportable_ops}\n\n` +
                        `Do you want to REPLACE the old report with the new one?\n\n` +
                        `‚ö†Ô∏è WARNING: The old report will be PERMANENTLY DELETED!`;

                    const userConfirmed = confirm(warningMsg);
                    console.log('[SAVE_REPORT] User decision:', userConfirmed ? 'CONFIRMED - Will replace' : 'CANCELLED - Will not save');

                    if (userConfirmed) {
                        // User confirmed - call saveReport again with replacement
                        console.log('[SAVE_REPORT] ‚úÖ User confirmed replacement - deleting old snapshot and saving new one');
                        statusEl.textContent = 'üîÑ Replacing old report...';
                        await saveReport(true, existingSnapshot.snapshot_id);
                    } else {
                        // User cancelled
                        console.log('[SAVE_REPORT] ‚ùå User cancelled - save aborted, old snapshot remains');
                        console.log('[SAVE_REPORT] Send Email button will remain HIDDEN');
                        statusEl.textContent = '‚ùå Save cancelled - duplicate report exists';
                        statusEl.className = 'status-message error';
                    }
                    return;
                }

                if (data.success) {
                    let message = '‚úÖ Report saved successfully!';
                    if (forceReplace) {
                        message = `‚úÖ Report replaced successfully! Old snapshot #${data.replaced_snapshot_id} deleted.`;
                    }
                    message += ' You can now send the email if you wish.';

                    statusEl.textContent = message;
                    statusEl.className = 'status-message success';

                    // Show the "Send Email" button
                    document.getElementById('sendEmailBtn').style.display = 'inline-block';
                    // Hide the "Save Report" button (already saved)
                    document.getElementById('saveReportBtn').style.display = 'none';
                } else {
                    statusEl.textContent = '‚ùå Error: ' + data.error;
                    statusEl.className = 'status-message error';
                }
            } catch (error) {
                statusEl.textContent = '‚ùå Error: ' + error.message;
                statusEl.className = 'status-message error';
            }
        }

        async function sendEmail() {
            console.log('[BUTTON CLICK] üìß Send Email to Recipients');
            if (!confirm('Are you sure you want to send this email to all recipients? This action cannot be undone.')) {
                console.log('[BUTTON CLICK] ‚ùå User cancelled send email confirmation');
                return;
            }
            console.log('[BUTTON CLICK] ‚úÖ User confirmed send email');

            // Prompt for Gmail App Password
            const password = prompt('Enter Gmail App Password to send email:');
            if (!password) {
                console.log('[BUTTON CLICK] ‚ùå No password entered - email cancelled');
                alert('Email sending cancelled - password required');
                return;
            }
            console.log('[BUTTON CLICK] ‚úÖ Password entered - sending email');

            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = 'Sending email...';
            statusEl.className = 'status-message info';

            try {
                const response = await fetch('/send_report_email', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        password: password
                    })
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.textContent = '‚úÖ ' + data.message;
                    statusEl.className = 'status-message success';

                    // Hide the send button after successful send
                    document.getElementById('sendEmailBtn').style.display = 'none';
                } else {
                    statusEl.textContent = '‚ùå Error: ' + data.error;
                    statusEl.className = 'status-message error';
                }
            } catch (error) {
                statusEl.textContent = '‚ùå Error: ' + error.message;
                statusEl.className = 'status-message error';
            }
        }

        // Distribution List Management
        async function loadDistributionList() {
            try {
                const response = await fetch('/get_distribution_list');
                const data = await response.json();

                if (data.success) {
                    // Update count
                    const count = data.to.length + data.cc.length;
                    const countEl = document.getElementById('recipientCount');
                    if (countEl) {
                        countEl.textContent = `${data.to.length} TO, ${data.cc.length} CC (${count} total)`;
                    }
                    return data;
                }
            } catch (error) {
                console.error('Error loading distribution list:', error);
            }
        }

        async function openDistributionModal() {
            console.log('[BUTTON CLICK] üìß Manage Recipients - opening modal');
            const data = await loadDistributionList();
            if (data && data.success) {
                console.log('[BUTTON CLICK] ‚úÖ Distribution list loaded successfully');
                document.getElementById('toRecipients').value = data.to.join('\n');
                document.getElementById('ccRecipients').value = data.cc.join('\n');
                document.getElementById('distributionModal').style.display = 'flex';
            } else {
                console.log('[BUTTON CLICK] ‚ùå Failed to load distribution list');
            }
        }

        function closeDistributionModal() {
            console.log('[BUTTON CLICK] ‚ùå Close Distribution Modal (Cancel)');
            document.getElementById('distributionModal').style.display = 'none';
            document.getElementById('distributionStatus').textContent = '';
            document.getElementById('distributionStatus').className = 'status-message';
        }

        async function saveDistributionList() {
            console.log('[BUTTON CLICK] üíæ Save Distribution List (Save Changes)');
            const toText = document.getElementById('toRecipients').value;
            const ccText = document.getElementById('ccRecipients').value;

            // Parse emails - one per line, filter empty lines
            const toEmails = toText.split('\n').map(e => e.trim()).filter(e => e);
            const ccEmails = ccText.split('\n').map(e => e.trim()).filter(e => e);
            console.log('[BUTTON CLICK] TO emails:', toEmails.length, 'CC emails:', ccEmails.length);

            const statusEl = document.getElementById('distributionStatus');
            statusEl.textContent = 'Saving...';
            statusEl.className = 'status-message info';

            try {
                const response = await fetch('/update_distribution_list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: toEmails,
                        cc: ccEmails
                    })
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.textContent = data.message;
                    statusEl.className = 'status-message success';

                    // Reload count
                    await loadDistributionList();

                    setTimeout(() => {
                        closeDistributionModal();
                    }, 1500);
                } else {
                    statusEl.textContent = 'Error: ' + data.error;
                    statusEl.className = 'status-message error';
                }
            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message;
                statusEl.className = 'status-message error';
            }
        }

        // Load distribution list count on page load
        if (document.getElementById('recipientCount')) {
            loadDistributionList();
        }
    </script>
</body>
</html>
